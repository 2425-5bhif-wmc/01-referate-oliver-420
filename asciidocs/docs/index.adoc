= Cron Jobs: Automated Backups for PostgreSQL
Daxinger Oliver
{docdate}
ifndef::sourcedir[:sourcedir: ../src/main/java]
ifndef::imagesdir[:imagesdir: images]
ifndef::backend[:backend: html5]
:icons: font
:sectnums:
:toc: left
:source-highlighter: rouge
:docinfo: shared

== PostgreSQL DB Backup und Restore

=== Warum überhaupt Backups?

Datenbanken sind einer der wichtigsten Bestandteile verschiedenster Anwendungen, sie speichern
wichtige Informationen, die für den Betrieb unerlässlich sind. +
Datenverlust kann schwerwiegende Folgen haben, wie z. B. finanzielle Verluste, verärgerte Kunden, etc. +
Daher ist es wichtig, regelmäßige Backups zu erstellen, um die Datenbank vor Datenverlust zu schützen.

=== Backup
Die Idee hinter einem SQL Dump ist es, eine Datei mit SQL-Befehlen zu erstellen, die, wenn sie ausgeführt wird,
die Datenbank in den Zustand zurückversetzen, in dem sie sich zum Zeitpunkt des Backups befand. +
Typischerweise enthält ein Backup alle oder ausgewählte Daten, Schema und Konfigurationseinstellungen die nötig sind,
um die Datenbank wiederherzustellen. +
Hierfür werden Utility Programs wie `pg_dump` und `pg_dumpall` verwendet:

* `pg_dump`:

Holt die Daten aus einer Datenbank und schreibt sie in ein Skript oder ein Archiv. +
Die Datei repräsentiert den snapshot (Schnappschuss) der Datenbank zur Zeit, an dem der Befehl ausgeführt wird. +

Syntax:

[source,bash]
----
pg_dump [option] [dbname] > [output_filename]
----

NOTE: Standardmäßig ist das Ausgabeformat von `pg_dump` ein SQL-Skript. +
Andere Formate können mit der Option `-F` angegeben werden.

Optionen für `pg_dump`:

[cols="1,2", options="header"]
|===
| Option | Beschreibung

| -U, --username=USERNAME
| Gibt den Benutzernamen für die Verbindung zur Datenbank an.

| -h, --host=HOSTNAME
| Gibt den Hostnamen des Servers an, auf dem der PostgreSQL-Server läuft.

| -p, --port=PORT
| Gibt die Portnummer an, auf der der PostgreSQL-Server lauscht.

| -d, --dbname=DBNAME
| Gibt den Namen der Datenbank an, die exportiert werden soll.

| -n, --schema=SCHEMA
| Gibt das Schema oder die Schemata an, die exportiert werden sollen. Mehrere Schemata können durch Kommata getrennt angegeben werden.

| -t, --table=TABLE
| Gibt die Tabelle oder Tabellen an, die exportiert werden sollen. Mehrere Tabellen können durch Kommata getrennt angegeben werden.

| -F, --format=FORMAT
| Gibt das Ausgabeformat an (z. B. plain (p), custom (c), directory (d)).

| -f, --file=FILENAME
| Gibt den Namen der Ausgabedatei an.

| -W, --password
| Erzwingt eine Passwortabfrage für die Verbindung zum PostgreSQL-Server.

| -w, --no-password
| Unterdrückt die Passwortabfrage, wenn das Passwort auf andere Weise bereitgestellt wird (z. B. `.pgpass`-Datei).

| -c, --clean
| Fügt SQL-Befehle hinzu, um die Datenbankobjekte vor dem Import zu löschen.

| -C, --create
| Fügt SQL-Befehle hinzu, um die Datenbank vor dem Import zu erstellen.

| -a, --data-only
| Exportiert nur die Daten, nicht die Schemas.

| -s, --schema-only
| Exportiert nur die Schemas, nicht die Daten.

| -x, --no-privileges
| Schließt Berechtigungen (GRANT/REVOKE-Befehle) aus dem Dump aus.

| -X, --no-owner
| Verhindert den Export von Objektbesitzinformationen (z. B. `OWNER TO`).

| --help
| Zeigt Hilfe und Nutzungsinformationen an.
|===

.Beispiele
[%collapsible]
====

.SQL-Format
[source,bash]
----
pg_dump -U app -h localhost db > backup/customers.sql
----

.tar-Format
[source,bash]
----
pg_dump -U app -h localhost -F t db > backup/customers.tar
----

.Directory-Format
[source,bash]
----
pg_dump -U app -h localhost -F d -f backup/backupDir db
----

====

=== Restore
Um eine PostgreSQL-Datenbank im Falle eines Datenverlusts wiederherzustellen, benutzt man die Werkzeuge `psql` oder
`pg_restore`. +
`psql` wird verwendet, um ein Backup-Skript im SQL-Format auszuführen, während `pg_restore` andere Formate
(custom, tar, directory) unterstützt. +

* `psql`:
[source,bash]
----
psql [option] < [backup_filename]
----

* `pg_restore`:
[source,bash]
----
pg_restore [option] [backup_filename]
----

Optionen:

[cols="1,2", options="header"]
|===
| Option | Beschreibung

| -U, --username=USERNAME
| Gibt den Benutzernamen für die Verbindung zur Datenbank an.

| -h, --host=HOSTNAME
| Gibt den Hostnamen des Servers an, auf dem der PostgreSQL-Server läuft.

| -p, --port=PORT
| Gibt die Portnummer an, auf der der PostgreSQL-Server lauscht.

| -d, --dbname=DBNAME
| Gibt den Namen der Datenbank an, die exportiert werden soll.

| -t, --table=TABLE
| Gibt die Tabelle oder Tabellen an, die exportiert werden sollen. Mehrere Tabellen können durch Kommata getrennt angegeben werden.

| -v, --verbose
| Gibt detaillierte Informationen über den Wiederherstellungsprozess aus.

| -c, --clean
| Löscht die Datenbankobjekte vor dem Import.

| -C, --create
| Erstellt die Datenbank vor dem Import.

| -e, --exit-on-error
| Beendet den Wiederherstellungsprozess, wenn ein Fehler auftritt.

| -F, --format=FORMAT
| Gibt das Format des Backup-Datei an (z. B. plain (p), custom (c), directory (d), tar (t)).

| -j, --jobs=NUM
| Gibt die Anzahl der gleichzeitig ausgeführten Jobs an.

| -n, --schema=SCHEMA
| Gibt das Schema oder die Schemata an, die wiederhergestellt werden sollen.

| -L, --use-list=FILENAME
| Gibt eine Datei an, die eine Liste der Dateien enthält, die wiederhergestellt werden sollen.

| -t, --tablespace=TABLESPACE
| Gibt den Tablespace an, in dem die Tabellen wiederhergestellt werden sollen.

| -V, --version
| Gibt die Version von `pg_restore` aus.

| -?, --help
| Zeigt Hilfe und Nutzungsinformationen an.

|===

.Beispiele
[%collapsible]
====

.SQL-File
[source,bash]
----
psql -U app -h localhost -d db < backup/customers.sql
----

.Tar-File
[source,bash]
----
pg_restore -U app -h localhost -d db backup/customers.tar
----

.Directory
[source,bash]
----
pg_restore -U app -h localhost -d db backup/backupDir
----
====

== Cron jobs

=== Was ist das?
Cron-Jobs sind zeitgesteuerte Aufgaben, die auf Unix- oder Linux-Systemen im Hintergrund automatisch ausgeführt werden.
Sie werden über den Cron-Dienst verwaltet und können so konfiguriert werden, dass sie Skripte, Befehle oder Programme
zu bestimmten Zeitpunkten oder in festgelegten Intervallen ausführen. Die Konfiguration erfolgt üblicherweise über
die Crontab-Datei.

=== Wie funktionieren Cron jobs?

* Crontab-Dateien
** Diese Dateien sind die 'Konfiguration' für Cron-Jobs.
** Jeder Benutzer hat eine Crontab-Datei, in der die einzelnen Aufgaben definiert werden.

* Cron-Dienst
** Ein Cron-Daemon läuft die ganze Zeit im Hintergrund und überwacht die Crontab-Dateien aller Benutzer.
** Dieser Daemon führt die definierten Aufgaben zum gegebenen Zeitplan aus.

* Zeitangaben
** Die verwendete Zeit von Cron ist die des Systems, auf dem es läuft.
** Cron überprüft minütlich, ob eine Aufgabe ausgeführt werden muss.

* Ausführung
** Befehle oder Skripts werden zur festgelegten Zeit oder in festgelegten Intervallen ausgeführt.
** Die Ausgabe kann man in einer Log-Datei speichern oder per E-Mail versenden, sofern konfiguriert.

=== Vorteile & Nachteile

Cron-Jobs sind das A&O für die Automatisierung von Aufgaben, jedoch gibt es neben den
zahlreichen Vorteilen auch einige Nachteile.

:!sectnums:

==== Vorteile

* Automatisierung
** Wiederkehrende Aufgaben können ohne manuellen Eingriff erledigt werden.

* Flexibilität
** Feine Zeitsteuerung für beliebige Zeitpläne.

* Effizienz
** Spart Zeit und reduziert die Wahrscheinlichkeit von menschlichen Fehlern.

* Einfachheit
** Minimaler Ressourcenverbrauch und einfache Konfiguration.

==== Nachteile

* Komplexität bei Fehlern
** Fehler bei der Konfiguration (z. B. falsche Zeitangaben) sind schwer zu fixen.

* Limitierte Logging-Funktionalität
** Ohne spezielle Vorkehrungen sind Cron-Jobs schwer zu überwachen.

* Sicherheitsrisiken
** Unvorsichtige Konfiguration kann Sicherheitslücken öffnen.

* Skalierbarkeit
** Bei vielen Aufgaben kann die Verwaltung und Überwachung von Cron-Jobs schwierig werden.

:sectnums:

=== Typische Anwendungsfälle

Cron Jobs werden beinahe überall eingesetzt, wo regelmäßige oder zeitgesteuerte Aufgaben anfallen, wie zum Beispiel:

* Automatisierte Backups
** Regelmäßiges Sichern von Datenbanken, Dateien oder Servern.

* Systemwartung
** Aufgaben wie das Leeren von temporären Dateien, das Rotieren von Logs oder das Aktualisieren von Paketen.

* Datenverarbeitung
** Verarbeitung oder Synchronisierung von Daten wie das Abrufen von APIs, das Erstellen von Log-Daten oder das Generieren von Berichten.

* Benachrichtigungen
** Versenden von Erinnerungen, Alerts oder Zusammenfassungen.


=== Cronjob Syntax

ifdef::backend-html5,backend-revealjs[image:cron_syntax.png[]]
ifdef::backend-pdf[image:cron_syntax.png[]]

== Cronjobs und PostgreSQL

=== Warum automatisierte Backups?

=== Backup-Strategien

== Automatisierte Backups mit Cronjobs

=== Einrichtung eines Cronjobs

=== Beispiel: Tägliches Backup

== Zusammenfassung

== Quellen

* https://neon.tech/postgresql/postgresql-administration/postgresql-backup-database
* https://www.postgresql.org/docs/current/backup.html
* https://www.tecmint.com/backup-and-restore-postgresql-database/
* https://www.hostinger.com/tutorials/cron-job
* https://www.postgresql.org/docs/current/app-pgrestore.html

